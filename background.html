<html>
  <head>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/sha1.js"></script>
    <script type="text/javascript" src="js/icon_creator.js"></script>
    <script type="text/javascript" src="js/timeline.js"></script>
    <script type="text/javascript" src="js/persistence.js"></script>
    <script type="text/javascript" src="js/options_backend.js"></script>
    <script type="text/javascript" src="js/fanfou_lib.js"></script>
  </head>
  <body>
  <script type="text/javascript">
    $.ajaxSetup({
      timeout: OptionsBackend.get("timeout")
    })
    var MAX_TWEET_SIZE = 140;
    function FanfouManager(user, passwd){
        this.unreadTweets = {}
        this.readTweets = {};
        this.newTweetsCallback = null;
        this.saveMessage =  '';
        this.isComposing = false
        this.currentTimeline = "home"

        this.timelines = {};
        this.timelines["home"] = new Timeline("home", this, OptionsBackend.get("home_refresh_interval"));
        this.timelines["mentions"] = new Timeline("mentions", this, OptionsBackend.get("memtions_refresh_interval"));
        this.timelines["dms"] = new Timeline("dms", this, OptionsBackend.get("dms_refresh_interval"));

        var that = this
        this.ffBackend = new FanfouLib(user, passwd, function(){
            that.giveMeTweets.call(that, "home", function(){});
            that.giveMeTweets.call(that, "mentions", function(){});
            that.giveMeTweets.call(that, "dms", function(){});
        });
    }

FanfouManager.prototype.eachTimeline = function(callback){
  for (var id in this.timelines){
    callback.call(id, this.timelines[id]);
  }
}
FanfouManager.prototype.updateAlert = function(){
  var unreadNewCount = 0;
  this.eachTimeline(function(timeline){
    unreadNewCount += timeline.newTweetsCount()[1];      
  })
  if (unreadNewCount == 0){
    chrome.browserAction.setBadgeText({text : ""});
  }else{
    var title = unreadNewCount + "条新消息";
    chrome.browserAction.setTitle({title: title});
    chrome.browserAction.setBadgeText({text : unreadNewCount + ""});
  }
}
FanfouManager.prototype.registerNewTweetsCallback = function(callback){
  this.newTweetsCallback = callback;
}
FanfouManager.prototype.readTweet = function(id){
  this.readTweets[id] = true;
  delete this.unreadTweets[id];
}
FanfouManager.prototype.isTweetRead = function(id){
  return !this.unreadTweets[id]
}
FanfouManager.prototype.notifyNewTweets = function(timelineId, size, unreadSize){
  try{
    this.newTweetsCallback(size, unreadSize, timelineId);
  }catch(e){}
  this.updateAlert();
}
FanfouManager.prototype.postTweet = function(callback, msg, replyId, postStatus){
  if (postStatus == "retweet"){
    return this.ffBackend.retweet(callback, msg, replyId);
  }else{
    return this.ffBackend.tweet(callback, msg, replyId);
  }
}

FanfouManager.prototype.favorite = function(callback, id, isNeed){
  if (isNeed){
    return this.ffBackend.favorite(callback, id);
  }else{
    return this.ffBackend.unfavorite(callback, id);
  }
}

FanfouManager.prototype.trashTweet = function(callback, id){
  return this.ffBackend.destroy(callback, id);
}

FanfouManager.prototype.giveMeTweets = function(timelineId, callback, syncNew, cacheOnly){
  return this.timelines[timelineId].giveMeTweets(callback, syncNew, cacheOnly);
}
FanfouManager.prototype.newTweetsCount = function(timelineId){
  return this.timelines[timelineId].newTweetsCount();
}
FanfouManager.prototype.updateNewTweets = function(){
  this.timelines[this.currentTimeline].updateNewTweets();
  this.updateAlert();
}
FanfouManager.prototype.getCurrentTimeline = function(){
  return this.timelines[this.currentTimeline];
}
FanfouManager.prototype.currentError = function(){
  return this.timelines[this.currentTimeline].currentError;
}
FanfouManager.prototype.stopAll = function(){
  this.eachTimeline(function(timeline){
    timeline.stopTimer();
    delete timeline;
  })
}
FanfouManager.prototype.clear = function(){
    this.unreadTweets = {}
    this.readTweets = {};
    this.newTweetsCallback = null;
    this.saveMessage =  '';
    this.isComposing = false
    this.currentTimeline = "home"
}
FanfouManager.prototype.signout = function(){
  this.stopAll();
  this.clear();
  FanfouManager.instance = null;
}

    function signin(user, passwd){
      FanfouManager.instance = new FanfouManager(user, passwd);
    }
    
     if (localStorage.remember && localStorage.logged){
        signin(localStorage.username, localStorage.password);
     }
  </script>
  </body>
</html>
